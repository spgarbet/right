---
title: "Clopidogrel Numerical Solution"
author: "Shawn Garbett"
date: "April 12, 2017"
output:
  html_document:
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The Model

The numerical solution is a 3 step approach. Step 1 is a delay differential equation (DDE) solution that is a subset of the full model. Step 2 is integrating outcomes over the compartments in the DDE model. Step 3 is running multiple runs and adding outcomes based on chosen strategies.

A delay differential equation model solves the expectation value of infinite runs. All the compartment of the full model are not required since multiple runs can be done on a subset of the model and probablistic sums of results can be done in Step 3. For example, prescribing an alternate and a mainline therapy is not required in the DDE model since each of these can be done in separate runs and averaged together based on the probability of each occurring. There is trade off between number of runs and complexity of DDE model. However, in general derivation of a representative DDE model is more complex thus the simplest is desired.

The DDE model has 6 principal compartments: 'notreat', 'phase1', 'phase2', 'phase3', 'maint' and 'mort'. 'notreat' represents untreated individuals in the simulation. 'phase1' is the initial 30 days of primary DAPT treatment. 'phase2' is the 2-12 months of primary DAPT treatment. 'phase3' is the 2-end of sim years of primary DAPT treatment. 'maint' are those on maintenance medication. 'mort' are those that have died for any reason. An few additional bookkeeping compartments are utilized: 'p1entry', 'p2entry', 'restart', and 'disc'. 'p1entry' are those patients that have been selected for treatment via the Weibull distribution and are entering treatment. 'p2entry' are those patients how are entering 'phase2' of therapy. 'restart' are all those patients who are restarting therapy. Finally, 'disc' is an easy way to compute discount rate in the same result matrix that makes later computation simpler.

The present DDE model does not allow for multiple restarts of treatment, although this could be added the results of allowing one stage are 1/1000 of the effect of primary treatment. Allowing a second round would be effecting the sixth significant digit (1/1000^2), and is neglected in this solution.

For step 2 integrations we use our earlier work in validation of delay differentials applied to queueing theory. 

DESCRIBE STEP 3 HERE

## The DDE Model

First we load the integrator and pull in model parameters.

```{r, echo=TRUE}
library(deSolve)

###################################
# Main model parameters

risk2rate <- function(risk, range) -(log(1-risk)/range)

params = list(

    # Indication Paramters (Weibull) source: VUMC data -- file is ./reference/WCS_KM_Distribution_Generation.pdf
    Shape = 0.59,
    Scale = 60475.53,
  
    # The Stent Thrombosis Risks are drawn from a piecewise exponential with the following
    # durations and rates. These are for clopidogrel
    ST.rate.30    = risk2rate(0.0150, 30/365),  # (0.010-0.020)
    ST.rate.365   = risk2rate(0.0060, 1),  # (0.003-0.009) -- ? http://circ.ahajournals.org/content/114/20/2154
    ST.rate.gt365 = risk2rate(0.0022, 5),  # (0.001-0.003)
    ST.pr.fatal   = 0.20,  # (15-30)
    ST.pr.CABG    = 0.10,  
  
    # Myocardial Infarction: Event Rates and Relative Risks
    MI.rate    = risk2rate(0.035,5), # 0.035, #(0.013-0.097)
    MI.pr.CABG = 0.08, # (4-12)
    MI.pr.PCI  = 0.55, # (45-65)

    # Revascularization
    RV.rate.365   = risk2rate(0.10, 1),     # (0.05-0.15)
    RV.rate.gt365 = risk2rate(0.03, 5),
    RV.pr.CABG    = 0.25, # (15-35)

    # Simplified bleed risk, and fatal risk -- One drug only
    Bleed.rate      = risk2rate(0.02+0.0230+0.0015, 1), # See model-simplification, Clopidogrel wildtype
    BleedFatal.rate = risk2rate(0.0015, 1), # (0.001-0.003), Clopidogrel wildtype

    #? vRiskCABGTIMImajor = 0.022, # (0.013-0.031) 


    
    # Genomic RR adjustments -- NOT USED HERE
    # vRR.MI.LOF = 1.48, #(1.05-2.07) High Discrimination Scenario = 1.45 (1.09-1.92)
    # vRR.Mort.LOF = 1.28, #(0.95-1.73) #Not sure how to use this one
    # vRR.Bleed.LOF = 0.84, # (0.75-1.00)
  
    disc_rate = 0.03
)
```

Next we set up instantaneous secular death rates, and their integrals.

```{r, echo=TRUE}

# This take a percent rate over a timeframe and returns the
# instantaneous exponential rate
inst_rate <- function(percent, timeframe)
{
  - log(1-percent) / timeframe
}

# Estimated Vanderbilt Secular Death first 10 years See:Secular.html
drate_alpha <- 0.0940359
drate_beta  <- 0.01272623
drate <- function(t) inst_rate(drate_beta*exp(drate_alpha*t), 1)
#drate <- function(t) rep(0, length(t))

# Compute rate exposure for delay differential usage
#F_drate <- Vectorize(function(t, years) {
#  integrate(drate, lower=max(t-years, 0), upper=min(t, 100))$value
#})
F_drate <- function(t, years) drate_beta* (exp(drate_alpha*t) - exp(drate_alpha*pmax((t-years),0))) / drate_alpha
```

This are the rates of pci events broken into first 30 days, first year, and thereafter and their exposure integrals.

```{r}
pci.rates <- function(params)
{
  with(params,
  {
    # MI Rate of PCI
    rate <- rep(MI.rate * MI.pr.PCI, 3)
    
    # RV
    rate <- rate + (1-RV.pr.CABG) * c(RV.rate.365, RV.rate.365, RV.rate.gt365)
    
    # ST
    fraction <- (1-ST.pr.fatal)*(1-ST.pr.CABG)

    rate + fraction*c(ST.rate.30, ST.rate.365, ST.rate.gt365)
  })
}


# Note: PCI rate is a function of therapy age (a) *not* time in simulation.
F_pci.rate <- function(a, years, params)
{
  low <- a - years
  sum(
    c(if(low > 30/365) 0 else if (a < 30/365) years else 30/365 - low,
      if(low < 30/365) {
        if(a < 1) a - 30/365 else 1 - 30/365
      } else {
        if(a < 1) max(a-low,0) else 1 - low
      },
      if(a < 1) 0 else if(low < 1) a-1 else a-low
     ) * pci.rates(params)
  )
}
```

Likewise we require rates of CABG and Bleed Fatalities
```{r, echo=TRUE}
cabg.rates <- function(params)
{
  with(params,
  {
    # MI Rate of CABG
    rate <- rep(MI.rate * MI.pr.CABG, 3)
    
    # RV
    rate <- rate + RV.pr.CABG * c(RV.rate.365, RV.rate.365, RV.rate.gt365)
    
    # ST
    fraction <- (1-ST.pr.fatal)*(ST.pr.CABG)

    rate + fraction*c(ST.rate.30, ST.rate.365, ST.rate.gt365)
  })
}

F_cabg.rate <- function(a, years, params)
{
  low <- a - years
  sum(
    c(if(low > 30/365) 0 else if (a < 30/365) years else 30/365 - low,
      if(low < 30/365) {
        if(a < 1) a - 30/365 else 1 - 30/365
      } else {
        if(a < 1) max(a-low,0) else 1 - low
      },
      if(a < 1) 0 else if(low < 1) a-1 else a-low
     ) * cabg.rates(params)
  )
}
```


The actual model is now constructed.

```{r, echo=TRUE}
###################################
# Numerical Delay Differential Equation
Clopidogrel <- function(t, y, params)
{
  with(as.list(c(y, params)), {

    r_d <- drate(t)
    fb  <- 0 # BleedFatal.rate # Fatal bleed rate for first 1st year only
    
    # Start of therapy Weibull rate
    # Start of therapy Weibull rate
    scale <- Scale/365
    shape <- Shape
    incoming <- if (t <= 0)     0 else notreat*shape * t^(shape - 1) / scale^shape
    
    pci.r <- pci.rates(params)
    
    # Fatal bleed loss

    # Starting 2nd phase of therapy after 1st month (minus mortality of those who started)
    start2   <- if (t < 30/365) 0 else lagderiv(t-30/365, 2)*exp(-F_drate(t,  30/365))*exp(-fb*30/365)
    # Available at end of 12 months of therapy (phase1+phase2) minus mortality
    avail3   <- if (t < 1)      0 else lagderiv(t-335/365,3)*exp(-F_drate(t, 335/365))*exp(-fb*335/365)
    # Those that finished therapy (minus PCI for last year)
    finish   <- avail3*exp(-F_pci.rate(1, 1, params))
    # Those that restart and continue therapy due to PCi
    start3   <- avail3 - finish

    # Those that finished 2nd (restarted) therapy, didn't die or have a fatal bleed in first year
    #fb.loss  <- -fb*if(abs(t-1) < 1) 1-abs(t-1) else 
    finish2 <- if(t<=1) 0 else integrate(Vectorize(function(a){
          lagderiv(a, 4)  # *exp(-F_drate(a, 1))
        }),
        lower=max(0, t-2),
        upper=t-1
      )$value 

    list(c(
            notreat = -incoming,
            p1entry = incoming,
            p2entry = start2,
            # Not quite ready to deal with restarts from phase3
            # Subtract out chances of death here is faster than in computing those that finish
            restart = sum(pci.r*c(phase1,phase2,phase3))*exp(-F_drate(t+1, 1)),
            phase1  = incoming - start2  - (fb+r_d)*phase1,
            phase2  = start2   - avail3  - (fb+r_d)*phase2,
            phase3  = start3   - finish2 - r_d*phase3,
            maint   = finish   + finish2 - r_d*maint,
            mort    = r_d*(phase1+phase2+phase3+maint) + fb*(phase1+phase2),
            bleed_f = fb*(phase1+phase2),
            disc    = -disc_rate*disc            # Simple discount rate
          )
    )
  })
}
```

Let's generate a simple run, and validate that the sum of compartments the represent the population sum to 1. This indicates that individuals were neither created nor lost in the solution. 

```{r, echo=TRUE}

yinit <- c(notreat=1, p1entry=0, p2entry=0,
           restart=0, phase1=0,  phase2=0,
           phase3=0,  maint=0,   mort=0,
           bleed_f=0,
           disc=1)
# units of years, increments of days
times <- seq(0, 10, by=1/365)

# Run the simulation
system.time(out <- dede(yinit, times, Clopidogrel, params))

# Check sensibility, i.e. all occupancy buckets sum to 1
# If this sums to 1 then no individual was created or lost in the model
all(abs(rowSums(out[,c('notreat','phase1','phase2', 'phase3', 'maint', 'mort')]) - 1) < 1e-8)
```

Further, the summation validation insures that the model is consistent in that starting with a population size of 1.0, it neither creates nor destroys any of that population within numerical error.

A plot is the next diagnostic validation.

```{r, echo=TRUE}
x <- out[,c("time", "notreat", "phase1", "phase2", "phase3")]
class(x) <- c("deSolve", "matrix")
plot(x)
```

The healthy population 'notreat' plot matches the original Kaplan Meier curve from Yaping's work. Note the characteristic shark fin shape. This is a result of the Weibull distribution, and theory predicts that if one plotted a bar chart of time to therapy after establishing a medical home on the source data this would be the observed shape. It's the shape of a Weibull with a delayed exit or queue in the time domain.

Notice that very few are in treatment in phase one of the total population at any time. Phase 2 is a little larger as the time frame is longer. An integration of any of these curves results in the amount of time the population is exposed to one of these phases. Phase 3 is on a very small scale over all, as the number of restarts is on a much smaller scale overall. 

```{r, echo=TRUE}
x <- out[,c("time", "restart", "maint", "mort", "bleed_f")]
class(x) <- c("deSolve", "matrix")
plot(x)
```