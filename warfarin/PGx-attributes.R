
predict_warfarin <- function(traj, inputs)
{
  # First, Get the Probability That the Risk Score Returns a Value Above the Threshold
  # Note: the sensitivity and specificty are defined over a fixed horizon (I think three years), not the model horizon.
  # Need to confirm the true horizon from Jonatan and Yaping. 
  traj %>%
    set_attribute("aPrWarfarin.Score.Eq1",  function(attrs)
      inputs$warfarin$vPREDICTsens * (attrs[['aTimeToStartWarfarin']] <= 365*5) + 
        (1 - inputs$warfarin$vPREDICTspec) * (1 - (attrs[["aTimeToStartWarfarin"]] < 365*5))) %>%
    
    # All this routine needs to do is set the genotyped attribute correctly
    # The main loop code will pick this up and triggers a "panel_test" if needed.
    set_attribute("aGenotyped_Warfarin", function(attrs)
      sample(1:2, 1, prob = c(attrs[['aPrWarfarin.Score.Eq1']], 1 - attrs[['aPrWarfarin.Score.Eq1']])))
}



